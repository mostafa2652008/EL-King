<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA9WXBcRf8QBsRAafAcnKYVFx_kF5B0Gr0",
      authDomain: "educate-a2aad.firebaseapp.com",
      projectId: "educate-a2aad",
      storageBucket: "educate-a2aad.firebasestorage.app",
      messagingSenderId: "237633521728",
      appId: "1:237633521728:web:1ec7e6aae3ae0711ef37a5"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let cards = [];
    let index = 0;
    let audio = null;
    const unitId = localStorage.getItem("currentUnitId");

    const unitTitle = document.getElementById("unitTitle");
    const front = document.getElementById("front");
    const back = document.getElementById("back");
    const cardDiv = document.getElementById("card");
    const resultDiv = document.getElementById("result");
    const progress = document.getElementById("progress");
    const progressFill = document.getElementById("progressFill");
    const avgDiv = document.getElementById("average");

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = SpeechRecognition ? new SpeechRecognition() : null;
    if (recognition) recognition.lang = "en-US";

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        localStorage.setItem("userId", user.uid);
        loadUnit();
      }
    });

    async function loadUnit() {
      if (!unitId) {
        document.body.innerHTML = "<h2 style='text-align:center;margin-top:50px;color:#D32F2F;'>âš ï¸ Ø§Ø®ØªØ± ÙˆØ­Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹</h2>";
        return;
      }

      try {
        const unitRef = doc(db, "units", unitId);
        const unitSnap = await getDoc(unitRef);

        if (!unitSnap.exists()) {
          document.body.innerHTML = "<h2 style='text-align:center;margin-top:50px;color:#D32F2F;'>âš ï¸ Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</h2>";
          return;
        }

        const data = unitSnap.data();
        cards = data.cards || [];
        unitTitle.textContent = data.unitName || "ÙˆØ­Ø¯Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©";

        if (cards.length === 0) {
          progress.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø©";
          return;
        }

        loadCard();

        cardDiv.addEventListener("click", flipCard);

        const soundBtn = document.querySelector('.back-buttons button:first-child');
        const micBtn = document.querySelector('.back-buttons button:last-child');

        if (soundBtn) soundBtn.addEventListener("click", playSound);
        if (micBtn) micBtn.addEventListener("click", startPronunciation);

        document.getElementById("prevBtn")?.addEventListener("click", prevCard);
        document.getElementById("nextBtn")?.addEventListener("click", nextCard);
      } catch (error) {
        console.error("Error loading unit:", error);
        document.body.innerHTML = "<h2 style='text-align:center;margin-top:50px;color:#D32F2F;'>Ø­Ø¯Ø« Ø®Ø·Ø£</h2>";
      }
    }

    function updateProgress() {
      if (cards.length === 0) return;
      const percent = ((index + 1) / cards.length) * 100;
      progressFill.style.width = percent + "%";
      progress.textContent = `Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ${index + 1} Ù…Ù† ${cards.length}`;
    }

    function loadCard() {
      if (cards.length === 0) return;
      cardDiv.classList.remove("flip");
      front.textContent = cards[index].arabic;
      back.textContent = cards[index].english;
      audio = new Audio(cards[index].audio);
      resultDiv.textContent = "";
      updateProgress();
    }

    function flipCard() {
      cardDiv.classList.toggle("flip");
    }

    function nextCard() {
      index = (index + 1) % cards.length;
      loadCard();
    }

    function prevCard() {
      index = (index - 1 + cards.length) % cards.length;
      loadCard();
    }

    function playSound(e) {
      e.stopPropagation();
      if (audio) audio.play();
    }

    function calculateAccuracy(spoken, correct) {
      spoken = spoken.toLowerCase().trim();
      correct = correct.toLowerCase().trim();
      if (spoken === correct) return 100;

      let match = 0;
      for (let i = 0; i < Math.min(spoken.length, correct.length); i++) {
        if (spoken[i] === correct[i]) match++;
      }
      return Math.round((match / correct.length) * 100);
    }

    function getGrade(acc) {
      if (acc >= 90) return "Ù…Ù…ØªØ§Ø² â­";
      if (acc >= 75) return "Ø¬ÙŠØ¯ ğŸ‘";
      return "ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ† âŒ";
    }

    async function startPronunciation(e) {
      if (!recognition) {
        resultDiv.textContent = "Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª";
        return;
      }

      e.stopPropagation();
      resultDiv.textContent = "ğŸ™ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹...";
      recognition.start();

      recognition.onresult = async (event) => {
        const spoken = event.results[0][0].transcript.trim();
        const correct = cards[index].english;
        const acc = calculateAccuracy(spoken, correct);
        const grade = getGrade(acc);

        try {
          const unitRef = doc(db, "units", unitId);
          const userId = localStorage.getItem("userId");
          const field = `cards.${index}.results.${userId}`;

          await updateDoc(unitRef, {
            [field]: {
              accuracy: acc,
              grade,
              spoken,
              timestamp: new Date().toISOString()
            }
          });

          resultDiv.innerHTML = `
            Ù‚Ù„Øª: "<strong>${spoken}</strong>"<br>
            Ø§Ù„Ø¯Ù‚Ø©: <strong>${acc}%</strong><br>
            Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: <strong>${grade}</strong>
          `;
        } catch (error) {
          console.error("Error saving result:", error);
          resultDiv.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©";
        }
      };

      recognition.onerror = () => {
        resultDiv.textContent = "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØªØŒ Ø¬Ø±Ø¨ ØªØ§Ù†ÙŠ";
      };
    }

    window.signOutUser = async () => {
      await signOut(auth);
      localStorage.removeItem("userId");
      localStorage.removeItem("currentUnitId");
      window.location.href = "login.html";
    };
  </script>

  <style>
    body { font-family: 'Tajawal', sans-serif; background: #f5f5f5; margin: 0; padding: 0; min-height: 100vh; display: flex; }
    .sidebar { width: 280px; background: white; box-shadow: 4px 0 20px rgba(0,0,0,0.1); position: fixed; top: 0; bottom: 0; right: 0; overflow-y: auto; z-index: 100; }
    .sidebar-header { background: #D32F2F; color: white; padding: 30px 20px; text-align: center; font-size: 22px; font-weight: 700; }
    .sidebar-menu { padding: 20px 0; }
    .menu-item { display: flex; align-items: center; padding: 18px 30px; color: #555; text-decoration: none; font-size: 18px; transition: all 0.3s; }
    .menu-item:hover { background: #f0f0f0; color: #D32F2F; }
    .menu-item.active { background: #D32F2F; color: white; font-weight: 700; }
    .menu-icon { font-size: 28px; margin-left: 16px; }
    .main-content { flex: 1; padding: 40px; margin-right: 280px; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .unit-title { font-size: 28px; font-weight: 700; color: #D32F2F; margin-bottom: 20px; }
    #progress { font-size: 22px; color: #555; margin-bottom: 30px; }
    .progress-bar { width: 380px; max-width: 90%; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin: 20px 0; }
    .progress-fill { height: 100%; background: #D32F2F; width: 0%; transition: width 0.4s ease; }
    .card-container { width: 420px; max-width: 95%; perspective: 1200px; margin: 20px 0; }
    .card { width: 100%; height: 500px; position: relative; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55); cursor: pointer; border-radius: 28px; box-shadow: 0 15px 50px rgba(0,0,0,0.2); }
    .card.flip { transform: rotateY(180deg); }
    .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 28px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; box-sizing: border-box; font-size: 36px; font-weight: 700; color: white; text-align: center; }
    .front { background: #D32F2F; }
    .back { background: #27ae60; transform: rotateY(180deg); }
    .back-content { width: 100%; text-align: center; }
    .back-buttons { margin-top: 40px; display: flex; gap: 24px; justify-content: center; flex-wrap: wrap; }
    .back-buttons button { padding: 18px 32px; font-size: 20px; border: none; border-radius: 20px; background: white; color: #333; cursor: pointer; transition: all 0.3s; box-shadow: 0 8px 20px rgba(0,0,0,0.15); font-weight: 600; display: flex; align-items: center; gap: 12px; }
    .back-buttons button i { font-size: 26px; }
    .back-buttons button:hover { transform: translateY(-6px); box-shadow: 0 15px 30px rgba(0,0,0,0.25); }
    #result { margin-top: 30px; font-size: 20px; line-height: 1.6; min-height: 60px; }
    .controls { display: flex; gap: 50px; margin-top: 40px; }
    .controls button { width: 80px; height: 80px; font-size: 42px; border: none; border-radius: 50%; background: #D32F2F; color: white; cursor: pointer; box-shadow: 0 10px 30px rgba(211, 47, 47, 0.35); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
    .controls button:hover { background: #b71c1c; transform: scale(1.2); box-shadow: 0 15px 40px rgba(211, 47, 47, 0.5); }
    .controls button:active { transform: scale(1.1); }
    #average { font-size: 20px; color: #333; margin-top: 40px; font-weight: 600; }
    @media (max-width: 768px) {
      .sidebar { width: 100%; height: auto; position: relative; box-shadow: none; }
      .main-content { margin-right: 0; padding: 20px; }
      body { flex-direction: column; }
      .card-container { width: 380px; height: 460px; }
      .card-face { font-size: 30px; padding: 30px; }
      .controls button { width: 70px; height: 70px; font-size: 38px; }
      .back-buttons button { padding: 16px 28px; font-size: 18px; }
    }
  </style>
</head>
<body>

  <div class="sidebar">
    <div class="sidebar-header">ğŸ“š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
    <div class="sidebar-menu">
      <a href="index.html" class="menu-item"><span class="menu-icon">ğŸ‘¨â€ğŸ«</span> Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯Ø±Ø³</a>
      <a href="student.html" class="menu-item"><span class="menu-icon">ğŸ‘¨â€ğŸ“</span> ØµÙØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</a>
      <a href="cards.html" class="menu-item active"><span class="menu-icon">ğŸƒ</span> Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</a>
      <a href="#" onclick="signOutUser(); return false;" class="menu-item">
        <span class="menu-icon">ğŸšª</span> Ø®Ø±ÙˆØ¬
      </a>
    </div>
  </div>

  <div class="main-content">
    <h2 class="unit-title" id="unitTitle"></h2>
    <h3 id="progress"></h3>

    <div class="card-container">
      <div class="card" id="card">
        <div class="card-face front" id="front"></div>
        <div class="card-face back">
          <div class="back-content">
            <div id="back"></div>
            <div class="back-buttons">
              <button>
                <i class="fas fa-volume-high"></i> ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª
              </button>
              <button>
                <i class="fas fa-microphone"></i> Ù†Ø·Ù‚ Ø§Ù„ÙƒÙ„Ù…Ø©
              </button>
            </div>
            <div id="result"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>

    <div class="controls">
      <button id="prevBtn"><i class="fas fa-chevron-left"></i></button>
      <button id="nextBtn"><i class="fas fa-chevron-right"></i></button>
    </div>

    <h4 id="average"></h4>
  </div>

</body>
</html>
