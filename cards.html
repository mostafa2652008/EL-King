<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Tajawal', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .sidebar {
      width: 280px;
      height: 100vh;
      background: linear-gradient(180deg, #D32F2F 0%, #b71c1c 100%);
      position: fixed;
      top: 0;
      right: 0;
      box-shadow: -8px 0 30px rgba(211,47,47,0.3);
      z-index: 1000;
      overflow-y: auto;
    }
    .sidebar-header {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      color: white;
      padding: 25px 20px;
      text-align: center;
      font-size: 20px;
      font-weight: 700;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    .sidebar-menu { padding: 10px 0; }
    .menu-item {
      display: flex;
      align-items: center;
      padding: 16px 25px;
      color: rgba(255,255,255,0.9);
      text-decoration: none;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
      border-right: 4px solid transparent;
      margin: 2px 10px;
      border-radius: 15px 0 0 15px;
    }
    .menu-item:hover {
      background: rgba(255,255,255,0.2);
      color: white;
      border-right-color: #fff;
      transform: translateX(-5px);
    }
    .menu-item.active {
      background: rgba(255,255,255,0.25);
      color: white;
      border-right-color: #FFEBEE;
      font-weight: 700;
    }
    .menu-icon {
      font-size: 22px;
      margin-left: 15px;
      width: 25px;
    }

    .main-content {
      margin-right: 280px;
      padding: 40px 30px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 60px;
    }

    .page-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .unit-title {
      font-size: 32px;
      font-weight: 700;
      color: #D32F2F;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    .progress-text {
      font-size: 20px;
      color: #555;
      font-weight: 500;
      margin-bottom: 30px;
    }

    .progress-bar {
      width: 100%;
      max-width: 500px;
      height: 12px;
      background: rgba(255,255,255,0.7);
      border-radius: 20px;
      overflow: hidden;
      margin: 25px auto;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #D32F2F, #FF5722);
      border-radius: 20px;
      width: 0%;
      transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 20px rgba(211,47,47,0.4);
    }

    .card-container {
      width: 100%;
      max-width: 480px;
      height: 550px;
      perspective: 1400px;
      margin: 40px 0;
    }

    .card {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.9s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      cursor: pointer;
      border-radius: 32px;
      box-shadow: 0 25px 70px rgba(0,0,0,0.25);
    }

    .card.flip {
      transform: rotateY(180deg);
    }

    .card-face {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 32px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 50px 40px;
      box-sizing: border-box;
      font-size: 44px;
      font-weight: 800;
      color: white;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      backdrop-filter: blur(15px);
    }

    .front {
      background: linear-gradient(135deg, #D32F2F 0%, #b71c1c 100%);
    }

    .back {
      background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
      transform: rotateY(180deg);
    }

    .back-content {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .back-buttons {
      margin-top: 35px;
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .back-buttons button {
      padding: 20px 35px;
      font-size: 18px;
      border: none;
      border-radius: 25px;
      background: rgba(255,255,255,0.95);
      color: #333;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
      font-family: 'Tajawal', sans-serif;
      backdrop-filter: blur(10px);
    }

    .back-buttons button:hover {
      transform: translateY(-8px) scale(1.05);
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }

    #result {
      margin-top: 30px;
      font-size: 18px;
      line-height: 1.8;
      min-height: 80px;
      text-align: center;
      background: rgba(255,255,255,0.2);
      padding: 20px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
      color: white;
      font-weight: 500;
    }

    .result-excellent {
      animation: celebrate 0.6s ease;
    }

    .result-good {
      animation: goodJob 0.4s ease;
    }

    .result-fair {
      animation: fadeIn 0.3s ease;
    }

    .result-poor {
      animation: fadeIn 0.3s ease;
    }

    @keyframes celebrate {
      0%, 100% { transform: scale(1); }
      25% { transform: scale(1.1) rotate(2deg); }
      75% { transform: scale(1.1) rotate(-2deg); }
    }

    @keyframes goodJob {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .controls {
      display: flex;
      gap: 60px;
      margin: 50px 0;
    }

    .control-btn {
      width: 90px;
      height: 90px;
      font-size: 28px;
      border: none;
      border-radius: 50%;
      background: linear-gradient(135deg, #D32F2F, #b71c1c);
      color: white;
      cursor: pointer;
      box-shadow: 0 15px 40px rgba(211,47,47,0.4);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .control-btn:hover {
      transform: scale(1.15) translateY(-5px);
      box-shadow: 0 25px 50px rgba(211,47,47,0.6);
    }

    .average-stats {
      font-size: 22px;
      color: #333;
      margin-top: 30px;
      font-weight: 600;
      text-align: center;
      background: rgba(255,255,255,0.9);
      padding: 20px 40px;
      border-radius: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .bottom-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
      padding: 12px 0;
      z-index: 999;
    }

    .bottom-nav a {
      flex: 1;
      text-align: center;
      padding: 10px;
      color: #666;
      text-decoration: none;
      font-size: 13px;
    }

    .bottom-nav a.active {
      color: #D32F2F;
      font-weight: 700;
    }

    .nav-icon {
      display: block;
      font-size: 24px;
      margin-bottom: 4px;
    }

    @media (max-width: 768px) {
      .sidebar { display: none; }
      .main-content { margin-right: 0; padding: 25px 20px; padding-bottom: 100px; }
      .bottom-nav { display: flex; }
      .card-container { height: 480px; }
      .card-face { font-size: 36px; padding: 35px 25px; }
      .controls { gap: 40px; }
      .control-btn { width: 75px; height: 75px; font-size: 24px; }
    }
  </style>
</head>
<body>
  <div class="sidebar">
  <div class="sidebar-header">
    <i class="fas fa-graduation-cap"></i> Ù…Ù†ØµØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ…
  </div>
  <div class="sidebar-menu">
    <a href="index.html" class="menu-item active">
      <i class="fas fa-user-graduate menu-icon"></i>
      ØµÙØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨
    </a>
    <a href="exam.html" class="menu-item">
      <i class="fas fa-clipboard-list menu-icon"></i>
      Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª
    </a>
  <a href="cards.html" class="menu-item">
      <i class="fas fa-cards menu-icon"></i>
      Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
    </a>
    <a href="#" class="menu-item" id="signOutBtn">
      <i class="fas fa-sign-out-alt menu-icon"></i>
      Ø®Ø±ÙˆØ¬
    </a>
  </div>
</div>


<!-- ========== Ù„Ù„ØµÙØ­Ø© cards.html ========== -->
<!-- Ø¶ÙŠÙ Ø§Ù„ÙƒÙˆØ¯ Ø¯Ù‡ ÙÙŠ Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± Ø¨ØªØ§Ø¹ ØµÙØ­Ø© cards.html -->

<div class="sidebar">
  <div class="sidebar-header">
    <i class="fas fa-graduation-cap"></i> Ù…Ù†ØµØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ…
  </div>
  <div class="sidebar-menu">
    <a href="index.html" class="menu-item">
      <i class="fas fa-user-graduate menu-icon"></i>
      ØµÙØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨
    </a>
    <a href="exam.html" class="menu-item">
      <i class="fas fa-clipboard-list menu-icon"></i>
      Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª
    </a>
    <a href="cards.html" class="menu-item active">
      <i class="fas fa-cards menu-icon"></i>
      Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
    </a>
    <a href="#" class="menu-item" id="signOutBtn">
      <i class="fas fa-sign-out-alt menu-icon"></i>
      Ø®Ø±ÙˆØ¬
    </a>
  </div>
</div>

 <div class="bottom-nav">
  <a href="student.html" class="active">
    <span class="nav-icon">ğŸ‘¨â€ğŸ“</span> Ø§Ù„Ø·Ø§Ù„Ø¨
  </a>
  <a href="exam.html">
    <span class="nav-icon">ğŸ“</span> Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª
  </a>
  <a href="cards.html">
    <span class="nav-icon">ğŸƒ</span> Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
  </a>
</div>

  <div class="main-content">
    <div class="page-header">
      <h1 class="unit-title" id="unitTitle">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h1>
      <div class="progress-text" id="progress">ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©...</div>
    </div>

    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>

    <div class="card-container">
      <div class="card" id="card">
        <div class="card-face front" id="front">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù„Ù„ØªÙ‚Ù„ÙŠØ¨</div>
        <div class="card-face back">
          <div class="back-content">
            <div id="back"></div>
            <div class="back-buttons">
              <button onclick="playSound(event)">
                <i class="fas fa-volume-high"></i> ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª
              </button>
              <button onclick="startPronunciation(event)">
                <i class="fas fa-microphone"></i> Ù†Ø·Ù‚ Ø§Ù„ÙƒÙ„Ù…Ø©
              </button>
            </div>
            <div id="result"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="controls">
      <button class="control-btn" id="prevBtn"><i class="fas fa-chevron-left"></i></button>
      <button class="control-btn" id="nextBtn"><i class="fas fa-chevron-right"></i></button>
    </div>

    <div class="average-stats" id="average">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ù‚Ø©: Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨...</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA9WXBcRf8QBsRAafAcnKYVFx_kF5B0Gr0",
      authDomain: "educate-a2aad.firebaseapp.com",
      projectId: "educate-a2aad",
      storageBucket: "educate-a2aad.firebasestorage.app",
      messagingSenderId: "237633521728",
      appId: "1:237633521728:web:1ec7e6aae3ae0711ef37a5"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let cards = [];
    let index = 0;
    let audio = null;

    const unitId = localStorage.getItem("currentUnitId");
    const unitTitle = document.getElementById("unitTitle");
    const front = document.getElementById("front");
    const back = document.getElementById("back");
    const cardDiv = document.getElementById("card");
    const resultDiv = document.getElementById("result");
    const progress = document.getElementById("progress");
    const progressFill = document.getElementById("progressFill");
    const avgDiv = document.getElementById("average");

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = SpeechRecognition ? new SpeechRecognition() : null;
    if (recognition) {
      recognition.lang = "en-US";
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.maxAlternatives = 3;
    }

    onAuthStateChanged(auth, (user) => {
      if (!user) return window.location.href = "login.html";
      localStorage.setItem("userId", user.uid);
      loadUnit();
    });

    async function loadUnit() {
      if (!unitId) {
        document.querySelector('.main-content').innerHTML = '<div class="empty-state">âš ï¸ Ø§Ø®ØªØ± ÙˆØ­Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹</div>';
        return;
      }

      try {
        const unitRef = doc(db, "units", unitId);
        const unitSnap = await getDoc(unitRef);
        if (!unitSnap.exists()) throw new Error("Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");

        const data = unitSnap.data();
        cards = data.cards || [];
        unitTitle.textContent = data.unitName || "ÙˆØ­Ø¯Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©";

        if (cards.length === 0) {
          progress.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø©";
          return;
        }

        loadCard();
        document.getElementById("prevBtn").addEventListener("click", prevCard);
        document.getElementById("nextBtn").addEventListener("click", nextCard);
        updateAverage();
      } catch (error) {
        console.error("Error:", error);
        document.querySelector('.main-content').innerHTML = '<div class="empty-state">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>';
      }
    }

    function updateProgress() {
      if (!cards.length) return;
      const percent = ((index + 1) / cards.length) * 100;
      progressFill.style.width = `${percent}%`;
      progress.textContent = `Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ${index + 1} Ù…Ù† ${cards.length}`;
    }

    function loadCard() {
      if (!cards.length) return;
      cardDiv.classList.remove("flip");
      front.textContent = cards[index].arabic;
      back.textContent = cards[index].english;
      audio = new Audio(cards[index].audio);
      resultDiv.textContent = "";
      updateProgress();
    }

    function flipCard() {
      cardDiv.classList.toggle("flip");
    }

    function nextCard() {
      index = (index + 1) % cards.length;
      loadCard();
    }

    function prevCard() {
      index = (index - 1 + cards.length) % cards.length;
      loadCard();
    }

    window.playSound = (e) => {
      e.stopPropagation();
      if (audio) audio.play().catch(() => {});
    };

    // Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ ÙˆØ¥Ø²Ø§Ù„Ø© Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ±Ù‚ÙŠÙ…
    function cleanText(text) {
      return text
        .toLowerCase()
        .trim()
        .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, "")
        .replace(/\s+/g, " ");
    }

    // Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Levenshtein Distance Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ´Ø§Ø¨Ù‡ Ø¨ÙŠÙ† Ø§Ù„Ù†ØµÙˆØµ
    function levenshteinDistance(str1, str2) {
      const len1 = str1.length;
      const len2 = str2.length;
      const matrix = Array(len1 + 1).fill(null).map(() => Array(len2 + 1).fill(0));

      for (let i = 0; i <= len1; i++) matrix[i][0] = i;
      for (let j = 0; j <= len2; j++) matrix[0][j] = j;

      for (let i = 1; i <= len1; i++) {
        for (let j = 1; j <= len2; j++) {
          const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
          matrix[i][j] = Math.min(
            matrix[i - 1][j] + 1,
            matrix[i][j - 1] + 1,
            matrix[i - 1][j - 1] + cost
          );
        }
      }

      return matrix[len1][len2];
    }

    function calculateAccuracy(spoken, correct) {
      const cleanSpoken = cleanText(spoken);
      const cleanCorrect = cleanText(correct);
      
      if (cleanSpoken === cleanCorrect) return 100;

      const distance = levenshteinDistance(cleanSpoken, cleanCorrect);
      const maxLen = Math.max(cleanSpoken.length, cleanCorrect.length);
      
      const accuracy = Math.max(0, Math.round(((maxLen - distance) / maxLen) * 100));

      return accuracy;
    }

    function getGrade(acc) {
      if (acc === 100) return "Ù…Ù…ØªØ§Ø² Ø¬Ø¯Ø§Ù‹ ğŸ†â­â­â­";
      if (acc >= 90) return "Ù…Ù…ØªØ§Ø² â­â­â­";
      if (acc >= 80) return "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹ ğŸ‘ğŸ‘";
      if (acc >= 70) return "Ø¬ÙŠØ¯ ğŸ‘";
      if (acc >= 50) return "Ù…Ù‚Ø¨ÙˆÙ„ ğŸ“–";
      return "ÙŠØ­ØªØ§Ø¬ ØªØ¯Ø±ÙŠØ¨ ğŸ“š";
    }

    function getFeedback(acc) {
      if (acc === 100) return "Ù†Ø·Ù‚ Ù…Ø«Ø§Ù„ÙŠ! ÙˆØ§ØµÙ„ Ø§Ù„ØªÙ…ÙŠØ² ğŸ‰";
      if (acc >= 90) return "Ù†Ø·Ù‚ Ù…Ù…ØªØ§Ø²! Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„ÙƒÙ…Ø§Ù„";
      if (acc >= 80) return "Ù†Ø·Ù‚ Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹! Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªØ¯Ø±ÙŠØ¨";
      if (acc >= 70) return "Ù†Ø·Ù‚ Ø¬ÙŠØ¯ØŒ Ø­Ø§ÙˆÙ„ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø£ÙƒØ«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø®Ø§Ø±Ø¬";
      if (acc >= 50) return "Ø¬ÙŠØ¯ Ù„Ù„Ø¨Ø¯Ø§ÙŠØ©ØŒ Ø§Ø³ØªÙ…Ø¹ Ù„Ù„ØµÙˆØª ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰";
      return "Ø§Ø³ØªÙ…Ø¹ Ø¬ÙŠØ¯Ø§Ù‹ Ù„Ù„Ù†Ø·Ù‚ Ø§Ù„ØµØ­ÙŠØ­ ÙˆØ­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹";
    }

    window.startPronunciation = async (e) => {
      if (!recognition) {
        resultDiv.innerHTML = "âŒ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª";
        return;
      }

      e.stopPropagation();
      resultDiv.innerHTML = "ğŸ™ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹... Ø§Ù†Ø·Ù‚ Ø§Ù„ÙƒÙ„Ù…Ø© Ø¨ÙˆØ¶ÙˆØ­!";

      try {
        recognition.start();
      } catch (error) {
        if (error.name === 'InvalidStateError') {
          recognition.stop();
          setTimeout(() => recognition.start(), 100);
        }
      }

      recognition.onresult = async (event) => {
        const spoken = event.results[0][0].transcript.trim();
        const confidence = event.results[0][0].confidence;
        const correct = cards[index].english;
        const acc = calculateAccuracy(spoken, correct);
        const grade = getGrade(acc);
        const feedback = getFeedback(acc);

        let colorClass = "result-excellent";
        if (acc < 90) colorClass = "result-good";
        if (acc < 70) colorClass = "result-fair";
        if (acc < 50) colorClass = "result-poor";

        try {
          const unitRef = doc(db, "units", unitId);
          const userId = localStorage.getItem("userId");

          const unitSnap = await getDoc(unitRef);
          if (!unitSnap.exists()) throw new Error("Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");

          const unitData = unitSnap.data();
          const currentCards = unitData.cards || [];
          const updatedCard = { ...currentCards[index] };

          if (!updatedCard.results) updatedCard.results = {};
          updatedCard.results[userId] = {
            accuracy: acc,
            grade,
            spoken,
            confidence: Math.round(confidence * 100),
            timestamp: new Date().toISOString()
          };

          const newCards = [...currentCards];
          newCards[index] = updatedCard;

          await updateDoc(unitRef, { cards: newCards });

          resultDiv.innerHTML = `
            <div class="${colorClass}">
              <div style="font-size: 24px; margin-bottom: 10px;">${grade}</div>
              <div style="margin-bottom: 8px;">ğŸ“ Ù‚Ù„Øª: "<strong>${spoken}</strong>"</div>
              <div style="margin-bottom: 8px;">âœ… Ø§Ù„ØµØ­ÙŠØ­: "<strong>${correct}</strong>"</div>
              <div style="margin-bottom: 8px;">ğŸ¯ Ø§Ù„Ø¯Ù‚Ø©: <strong>${acc}%</strong></div>
              <div style="margin-bottom: 8px;">ğŸ”Š Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØª: <strong>${Math.round(confidence * 100)}%</strong></div>
              <div style="font-size: 16px; margin-top: 10px; opacity: 0.9;">${feedback}</div>
            </div>
          `;

          updateAverage();
        } catch (error) {
          console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸:", error);
          resultDiv.innerHTML = "âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰";
        }
      };

      recognition.onerror = (event) => {
        let errorMsg = "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª";
        
        switch(event.error) {
          case 'no-speech':
            errorMsg = "âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØªØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰";
            break;
          case 'audio-capture':
            errorMsg = "âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†";
            break;
          case 'not-allowed':
            errorMsg = "âš ï¸ ÙŠØ¬Ø¨ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†";
            break;
          case 'network':
            errorMsg = "âš ï¸ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª";
            break;
        }
        
        resultDiv.innerHTML = errorMsg;
      };

      recognition.onend = () => {
        // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ø¥Ø¬Ø±Ø§Ø¡ Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
      };
    };

    function updateAverage() {
      const userId = localStorage.getItem("userId");
      let total = 0, count = 0;

      cards.forEach(card => {
        if (card.results?.[userId]) {
          total += card.results[userId].accuracy;
          count++;
        }
      });

      const avg = count ? Math.round(total / count) : 0;
      avgDiv.innerHTML = `Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ù‚Ø©: <strong>${avg}%</strong> (${count} Ù…Ù† ${cards.length} Ø¨Ø·Ø§Ù‚Ø©)`;
    }

    window.signOutUser = async () => {
      await signOut(auth);
      localStorage.clear();
      window.location.href = "login.html";
    };

    cardDiv.addEventListener("click", flipCard);
  </script>
</body>
</html>


